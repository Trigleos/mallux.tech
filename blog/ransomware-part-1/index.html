<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> Ransomware Part I -Mallux </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="Investigate a Ransomware executable and reverse the encryption- Ransomware Part I"> <meta name="keywords" content="Ransomware Part I, Mallux, Assembly, Reversing, Linux_Reversing, Ransomware,Ransomware, CTF, XOR encryption, Reverse Engineering, radare2"/> <meta content="" property="fb:app_id" /> <meta content="Mallux" property="og:site_name" /> <meta content="Ransomware Part I" property="og:title" /> <meta content="article" property="og:type" /> <meta content="Investigate a Ransomware executable and reverse the encryption" property="og:description" /> <meta content="/blog/ransomware-part-1/" property="og:url" /> <meta content="2020-10-18T18:00:00+00:00" property="article:published_time" /> <meta content="/about/" property="article:author" /> <meta content="/assets/img/posts/ransomware-part-1/WannaCry.jpg" property="og:image" /> <meta content="Assembly" property="article:section" /> <meta content="Windows" property="article:tag" /> <meta content="Reversing," property="article:tag" /> <meta content="Reversing," property="article:tag" /> <meta content="C#," property="article:tag" /> <meta content="Ransomware" property="article:tag" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="Ransomware Part I" /> <meta name="twitter:url" content="/blog/ransomware-part-1/" /> <meta name="twitter:description" content="Investigate a Ransomware executable and reverse the encryption" /> <link rel="stylesheet" href="/assets/css/main.css" /> <!-- <link rel="stylesheet" href="/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = '' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="/assets/js/search.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <!-- for Mathjax support --> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">Mallux</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="/blog" >Blog</a > </li> </ul> </div> <ul class="nav justify-content-end"> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <li class="nav-item"> <input class="nav-link switch" id="theme-toggle" onclick="modeSwitcher() " type="checkbox" name="checkbox" /> </li> </ul> </nav> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div> <div class="col-lg-12"> <div class="row" id="blog-post-container"> <div class="col-lg-8 offset-md-2"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">Ransomware Part I</h1> <h4 class="post-meta">Investigate a Ransomware executable and reverse the encryption</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="/blog/authors/trigleos">trigleos</a></span> </span > at <time datetime="2020-10-18 18:00:00 +0000" itemprop="datePublished" >Oct 18, 2020</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/ransomware-part-1/" ></span> <div class="post-categories"> Category : <a href="/blog/categories/Assembly" >Assembly</a > &nbsp; <a href="/blog/categories/Reversing" >Reversing</a > &nbsp; <a href="/blog/categories/Linux_Reversing" >Linux_Reversing</a > &nbsp; <a href="/blog/categories/Ransomware" >Ransomware</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="/assets/img/posts/ransomware-part-1/WannaCry.jpg" alt="" /> <br /> <br /> <h1 id="castorsctf2020">castorsCTF2020</h1> <h2 id="tldr">TL;DR</h2> <p>Investigating a Ransomware attack and try to reverse the process</p> <h2 id="description">Description</h2> <p>Ransomware has been an increasing problem for companies as well as normal internet users. Criminals use malware to encrypt files on your computer and they’ll only give you the decryption key if you transfer them a specified amount of money. castorsCTFs Ransom challenge had a similar approach, with the only difference that the encryption used here was easily reversible by investigating the executable as well as the recorded network traffic. It still was a very fun challenge and taught me a lot about investigating Linux malware.</p> <h2 id="basic-investigation">Basic investigation</h2> <p>The challenge gives us the encrypted flag.png file as well as a ransom executable and a network capture. Let’s first investigate what the executable does by running strings and ltrace on it and record any significant discoveries. strings returns a lot of data and it is kind of hard to get anything out of it. ltrace however stops at one point and returns valuable info:</p> <p><img src="/assets/img/posts/ransomware-part-1/ccc.png" alt="C&amp;C" /></p> <p>We can see here that the executable tries to contact a server sitting at 192.168.0.2 using the http protocol trying to get the page /seed. Currently, that server seems to be down however. So just by running a simple ltrace, we’ve alround found the C&amp;C server. Now let’s open up the executable in radare2 and take a look at the precise inner workings</p> <h2 id="reverse-engineering">Reverse Engineering</h2> <p>Looking into the executable’s main function, we find sym.main.getSeed, sym.main.send, sym.main.encrypt and sym.main.main. So let’s start at sym.main.main (Tip:if you don’t want to wait for radare to finish analyzing every function because that can take some time, just go to sym.main.main and define a function at that address using af, in my case the exact command was af @ 0x00640730)</p> <h3 id="symmainmain">sym.main.main</h3> <p>Let’s check how this function starts. Ignoring the memory allocation at the beginning, the executable starts off with a call to main.getSeed and after that a call to main.send</p> <p><img src="/assets/img/posts/ransomware-part-1/first_r2.png" alt="main" /></p> <p>After that the program does a few checks to examine the results from the previous function calls. By quickly analysing the aftermath of the call to sym.send we can assume that sym.send returned two variables on the stack, var_38h and var_30h and sym.getSeed returned one, var_28h, and that they got put into rax, rcx and rdx respectively. The first check that is performed is checking if rdx is zero. If yes, the flow goes to the “failed” part (trust me on this). rdx probably contains the seed value from the main.getSeed function so the test just checks if getSeed finished successfully. On to the next checks:</p> <p><img src="/assets/img/posts/ransomware-part-1/second_r2.png" alt="checks" /></p> <p>First of all, rcx is compared to three. We can’t yet do that much with that information so let’s leave it. After that the two bytes that are saved where rax points to are compared with 0x6b6f. When something has a 6 or a 7 as first digit, always check if it might be ASCII. In this case, 0x6b6f = “ko” and, considering endianness, this might spell “ok”. Check number three compares the third byte stored at rax with 0xa, the return character. Now we also understand what rcx stands for. It probably contains the length of the string that we got send so rax contains the string we got send. In a nutshell, the executable checks if sym.send gave us the string “ok”, if not flow goes to the “failed” branch. But let’s first check what happens if the flow goes to the “success” branch:</p> <p><img src="/assets/img/posts/ransomware-part-1/third_r2.png" alt="success" /></p> <p>The logic here is quite easy, the executable just calls a math.Rand.Seed function, probably with var_38 as an argument, which now contains the value saved in rdx which, as we established earlier, is the result from the getSeed function. So let’s go on to the failed branch.</p> <p><img src="/assets/img/posts/ransomware-part-1/four_r2.png" alt="fail" /></p> <p>Without going to much into detail, the program calls time.Now which returns the current time, then performs some transformations on it and finally also calls math.Rand.Seed</p> <p><img src="/assets/img/posts/ransomware-part-1/five_r2.png" alt="seed" /></p> <p>In the end, both program flows come back together and main.encrypt is called.</p> <p><img src="/assets/img/posts/ransomware-part-1/six_r2.png" alt="encrypt" /></p> <p>To verify our claims, let’s have a quick look into main.getSeed and main.send</p> <h3 id="symmainsend-and-symmaingetseed">sym.main.send and sym.main.getSeed</h3> <p>Without going to much into details, in main.getSeed we get a call to net_http._Client.Get which has http://192.168.0.2:8081/seed as one of its arguments. This is the point we noticed earlier, where the executable tries to contact its C&amp;C server. Continuing the analysis, we can find a few calls to string manipulation functions as well as a call to Atoi which converts a string to an integer.</p> <p>sym.main.send is as well quite big but one thing to notice is the call to sym.net_http._Client.Post with the C&amp;C server as an argument. So now let’s finally look at main.encrypt</p> <h3 id="symmainencrypt">sym.main.encrypt</h3> <p>Again, a pretty big function but let’s focus on the essential. A call to Rand.Intn which probably returns a random integer after we’ve set the seed earlier in the main function. Several calls to os.File.Read, os.File.Write and os.OpenFile with flag.png as an argument. But the important part of the function happens in a very short area.</p> <p><img src="/assets/img/posts/ransomware-part-1/seven_r2.png" alt="main encryption stub" /></p> <p>So let’s go through this systematically. We have an iterative variable var_490 which is increased by one and is compared against 1024. We have a structure on top of the stack that is xored with a value stored in edx. And we have a call to math.rand.Intn which has the value 254 as an argument, probably the range of random numbers that we want (254 is exactly one byte). Now let’s assume that the result from that call to Rand.Intn gets put into rdx. In summary, a structure on top of the stack gets xored 1024 times with a random integer between 0 and 254. After this part we can see a call to File.Write so we can assume that the result is written to the flag.png file. We now have everything we need from the executable so let’s summarize our findings.</p> <h2 id="executable-summary">Executable summary</h2> <p>The executable contacts the C&amp;C server for a seed, if it doesn’t get one, it calculates it own based on the current time. After that, it sets the random function to that seed and calls the encrypt function which opens and reads the flag.png file and xors it byte by byte with a random integer between 0 and 256. The result is then written again to the flag.png file. A thing to note here is that random never means truly random in computer world. We use the term pseudo-randomness in this context. Pseudo-randomness functions in a way that a “random” function gets seeded and based on that seed calculates each random value. In many programming languages, the programmer doesn’t have to specify a seed, if the random function is called without an argument, the compiler just uses the current time as seed. A last thing to gain from this executable is to determine which programming language was used, because different programming languages use different random number generators and we need to find the right one if we want to get the same numbers later to reverse the process. This actually took me some time because I just assumed it to be C but if you search up the function names such as Fprintln or Rand.Intn you soon find references to Golang. If you look at strings within the executable, you can also find a lot that hint towards the use of Go so that’s what we’re gonna go with.</p> <p>I’ll finish the solution of this challenge in the next part, because this post is already quite long and complicated. I wanted to give a detailed look into the process of reverse engineering a ransomware because writeups often assume a certain base knowledge and I tried here to explain every single little step that can be taken to get to the solution</p> <p>-Trigleos</p> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="/blog/ransomware-part-1/" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About Pol Thill </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="/assets/img/authors/trigleos.png" alt="Pol Thill" /> </div> <div class="col-md-6"> <p class="author_bio">Hi I am Pol, a Cybersecurity student.</p> <p>Email : pthill99@gmail.com</p> <p>Website : https://trigleos.github.io</p> <p class="profile-links"> <a class="social-link" href="https://github.com/trigleos" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/pol-thill-985b02190" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> <a class="social-link" href="https://www.twitter.com/tr3gleos" target="_blank"><i class="fab fa-twitter fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> </div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About Mallux</div> <div class="card-body"> <p class="author_bio">Mallux is a blog where I write about Cybersecurity.</p> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#Csharp"></div> <li class="tag-head"> <a href="/blog/categories/Csharp">Csharp</a> </li> <a name="Csharp"></a> <div id="#Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Reversing">Reversing</a> </li> <a name="Reversing"></a> <div id="#Windows_Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Windows_Reversing">Windows_Reversing</a> </li> <a name="Windows_Reversing"></a> <div id="#Assembly"></div> <li class="tag-head"> <a href="/blog/categories/Assembly">Assembly</a> </li> <a name="Assembly"></a> <div id="#Linux_Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Linux_Reversing">Linux_Reversing</a> </li> <a name="Linux_Reversing"></a> <div id="#Ransomware"></div> <li class="tag-head"> <a href="/blog/categories/Ransomware">Ransomware</a> </li> <a name="Ransomware"></a> <div id="#Networking"></div> <li class="tag-head"> <a href="/blog/categories/Networking">Networking</a> </li> <a name="Networking"></a> <div id="#Forensics"></div> <li class="tag-head"> <a href="/blog/categories/Forensics">Forensics</a> </li> <a name="Forensics"></a> <div id="#RSA"></div> <li class="tag-head"> <a href="/blog/categories/RSA">RSA</a> </li> <a name="RSA"></a> <div id="#AES"></div> <li class="tag-head"> <a href="/blog/categories/AES">AES</a> </li> <a name="AES"></a> <div id="#Threat_Hunting"></div> <li class="tag-head"> <a href="/blog/categories/Threat_Hunting">Threat_Hunting</a> </li> <a name="Threat_Hunting"></a> <div id="#Incident_Response"></div> <li class="tag-head"> <a href="/blog/categories/Incident_Response">Incident_Response</a> </li> <a name="Incident_Response"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="/">Home</a> </li> <li> <a href="/blog">Blog</a> </li> </div> </div> </div> </div> </div><footer> <p> Powered by<a href="https://github.com/sujaykundu777/devlopr-jekyll"> devlopr jekyll</a>.Hosted on <a href="https://www.netlify.com/">Netlify</a>. </p> </footer> <script> var options = { classname: 'my-class', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <script src="/assets/js/mode-switcher.js"></script> </body> </html>
