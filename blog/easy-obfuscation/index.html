<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> Easy Obfuscation -Mallux </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="Reverse executable that uses clever function renaming techniques- Easy Obfuscation"> <meta name="keywords" content="Easy Obfuscation, Mallux, Reversing, Linux_Reversing,Reversing, CTF, Linux Reversing"/> <meta content="" property="fb:app_id" /> <meta content="Mallux" property="og:site_name" /> <meta content="Easy Obfuscation" property="og:title" /> <meta content="article" property="og:type" /> <meta content="Reverse executable that uses clever function renaming techniques" property="og:description" /> <meta content="/blog/easy-obfuscation/" property="og:url" /> <meta content="2020-12-19T18:00:00+00:00" property="article:published_time" /> <meta content="/about/" property="article:author" /> <meta content="/assets/img/posts/easy-obfuscation/ghidra.png" property="og:image" /> <meta content="Reversing" property="article:section" /> <meta content="Linux" property="article:tag" /> <meta content="Reversing," property="article:tag" /> <meta content="Reversing" property="article:tag" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="Easy Obfuscation" /> <meta name="twitter:url" content="/blog/easy-obfuscation/" /> <meta name="twitter:description" content="Reverse executable that uses clever function renaming techniques" /> <link rel="stylesheet" href="/assets/css/main.css" /> <!-- <link rel="stylesheet" href="/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = '' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="/assets/js/search.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <!-- for Mathjax support --> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">Mallux</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="/blog" >Blog</a > </li> </ul> </div> <ul class="nav justify-content-end"> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <li class="nav-item"> <input class="nav-link switch" id="theme-toggle" onclick="modeSwitcher() " type="checkbox" name="checkbox" /> </li> </ul> </nav> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div> <div class="col-lg-12"> <div class="row" id="blog-post-container"> <div class="col-lg-8 offset-md-2"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">Easy Obfuscation</h1> <h4 class="post-meta">Reverse executable that uses clever function renaming techniques</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="/blog/authors/trigleos">trigleos</a></span> </span > at <time datetime="2020-12-19 18:00:00 +0000" itemprop="datePublished" >Dec 19, 2020</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/easy-obfuscation/" ></span> <div class="post-categories"> Category : <a href="/blog/categories/Reversing" >Reversing</a > &nbsp; <a href="/blog/categories/Linux_Reversing" >Linux_Reversing</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="/assets/img/posts/easy-obfuscation/ghidra.png" alt="" /> <br /> <br /> <h1 id="thou-shall-pass">Thou shall pass?</h1> <h2 id="tldr">TL;DR</h2> <p>Reverse executable that uses clever function renaming techniques</p> <h2 id="description">Description</h2> <p>This was a challenge from the X-MAS CTF 2020. It was the easiest one in the Reversing category but I still think it was pretty fun because it introduced me to an interesting obfuscation technique.</p> <h2 id="challenge-description">Challenge Description</h2> <p>For thou to pass, the code might not but be entered</p> <p><strong>Author:</strong> Th3R4nd0m The challenge provides us with a simple ELF binary to run</p> <h2 id="basic-dynamic-analysis">Basic Dynamic Analysis</h2> <p>Let’s run the binary and see how it works:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./thou_shall_pass 
Thou shall  not pass  till  thou say the code
X-MAS<span class="o">{</span><span class="nb">test</span><span class="o">}</span>
Thou shall pass! Or maybe not?
</code></pre></div></div> <p>We can see that the program asks us for input, then checks it and based on those checks probably returns either true or false. A first thing we can do to see what the binary is doing is to run ltrace and see which library functions the program calls:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ltrace ./thou_shall_pass 
ptrace<span class="o">(</span>0, 0, 0x7ffdce31de58, 0x7f1b479c9718<span class="o">)</span>     <span class="o">=</span> <span class="nt">-1</span>
<span class="nb">printf</span><span class="o">(</span><span class="s2">"Pls no"</span><span class="o">)</span>                                 <span class="o">=</span> 6
<span class="nb">exit</span><span class="o">(</span>1Pls no &lt;no <span class="k">return</span> ...&gt;
+++ exited <span class="o">(</span>status 1<span class="o">)</span> +++
</code></pre></div></div> <p>Here we can see the first anti-analysis measure, a call to ptrace which basically tries to attach itself as a debugger on the running process. This call fails when there’s already a debugger attached (in our case ltrace) and returns -1. The program detects that and prints “Pls no” and aborts. To solve this, we can patch out the call to ptrace or do something else so the program doesn’t exit. Let’s have a look at where the binary calls ptrace. I’ll be using radare2 throughout this writeup as I think it’s a great reverse engineering tool for dynamic analysis as well as ghidra for a more high-level overview of the source code</p> <h2 id="locating-ptrace">Locating ptrace</h2> <p>This binary has been stripped, which means that all symbols that don’t have anything to do with dynamic linking have been removed. Basically, the only function or variable names that still remain are those from external libraries like strcmp or printf. Let’s take a look at the main function for our binary:</p> <p><img src="/assets/img/posts/easy-obfuscation/thou_shall1.png" alt="main" /></p> <p>As we can see here, the main function is rather short but seems to contain a lot of library calls but we can’t find a call to ptrace. The only other function we can find is a call to fcn.00401211 so let’s take a look at that.</p> <p><img src="/assets/img/posts/easy-obfuscation/thou_shall2.png" alt="ptrace" /></p> <p>Here we can see the call to ptrace, followed by a check whether rax is zero. Let’s patch that check out so we don’t exit when we debug. As we can see, the binary uses jns (jump if not sign) to check if the result of the call to ptrace is negative and then skips the exit routine if it isn’t. To patch this, we’ll just replace the opcode for jns (0x79) with the opcode for jmp (0xeb) and we can finally debug our program.</p> <h2 id="further-dynamic-analysis">Further dynamic analysis</h2> <p>Now that we can use ltrace, let’s see what we can find:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ltrace ./thou_shall_patch 
ptrace<span class="o">(</span>0, 0, 0x7fffd0fc3248, 0x7f988bddf718<span class="o">)</span>                <span class="o">=</span> <span class="nt">-1</span>
puts<span class="o">(</span><span class="s2">"Thou shall  not pass  till  thou"</span>...Thou shall  not pass  till  thou say the code
<span class="o">)</span>                 <span class="o">=</span> 46
fgets<span class="o">(</span>X-MAS<span class="o">{</span><span class="nb">test</span><span class="o">}</span>
<span class="s2">"X-MAS{test}</span><span class="se">\n</span><span class="s2">"</span>, 31, 0x7f988bddf980<span class="o">)</span>                  <span class="o">=</span> 0x7fffd0fc3120
strchr<span class="o">(</span><span class="s2">"X-MAS{test}</span><span class="se">\n</span><span class="s2">"</span>, <span class="s1">'\003'</span><span class="o">)</span>                             <span class="o">=</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">03</span><span class="se">\0</span><span class="s2">04</span><span class="se">\0</span><span class="s2">05</span><span class="se">\0</span><span class="s2">06</span><span class="se">\a\b\t\n\v\f\r\0</span><span class="s2">16</span><span class="se">\0</span><span class="s2">17</span><span class="se">\0</span><span class="s2">20</span><span class="se">\0</span><span class="s2">21</span><span class="se">\0</span><span class="s2">22</span><span class="se">\0</span><span class="s2">23</span><span class="se">\0</span><span class="s2">24</span><span class="se">\0</span><span class="s2">25</span><span class="se">\0</span><span class="s2">26</span><span class="se">\0</span><span class="s2">27</span><span class="se">\0</span><span class="s2">30</span><span class="se">\0</span><span class="s2">31</span><span class="se">\0</span><span class="s2">32</span><span class="se">\0</span><span class="s2">33</span><span class="se">\0</span><span class="s2">34</span><span class="se">\0</span><span class="s2">35</span><span class="se">\0</span><span class="s2">36</span><span class="se">\0</span><span class="s2">37 !""...
system("</span><span class="se">\3</span>02ij<span class="se">\n\2</span>32<span class="se">\3</span>33<span class="se">\2</span>43+<span class="se">\2</span>33<span class="se">\2</span>43<span class="se">\3</span>53P<span class="s2">")                = -788778691
strrchr("</span><span class="se">\3</span>07om<span class="se">\0</span>02<span class="se">\2</span>23<span class="se">\3</span>21<span class="se">\2</span>50<span class="s1">'\226\255\344@\021\022\023\024\227\276\025\030\031\032\033\034\233\236\035 !"", '</span><span class="se">\0</span>02<span class="s1">') = "\002\003\004\005\006\a\b\t\n\v\f\r\016\017\020\021\022\023\024\025\026\027\030\031\032\033\034\035\036\037 !"...
strcmp("\361\333[\200\344t*\311\245k9\020D\204\304\005\345\257E\006F\206\306\a\346\247G\bH\210", "\373\321Q\212\356~Ti\233ow\260\200\356p\301)gq\344\234\352r\355\223_\021\352\244x" &lt;unfinished ...&gt;
strncmp("\373\321Q\212\356~ \303\257a3\032N\216\316\017\357\245O\fL\214\314\r\354\255M\002B\202", "\373\321Q\212\356~Ti\233ow\260\200\356p\301)gq\344\234\352r\355\223_\021\352\244x", 31) = -52
&lt;... strcmp resumed&gt; )                                      = 0
puts("Thou shall pass! Or maybe not?"Thou shall pass! Or maybe not?
)                      = 31
+++ exited (status 0) +++
</span></code></pre></div></div> <p>We can see several calls to C library functions like strchr and strcmp that apparently change our string. However, we can see that the call to strchr (which normally returns the first occurence of a substring in a given string) doesn’t even return a number but instead takes our input and seems to transform it into something longer. Let’s investigate the function we saw earlier that gets called after the ptrace check, fcn.004011b2:</p> <p><img src="/assets/img/posts/easy-obfuscation/thou_shall3.png" alt="first function" /></p> <p>Something interesting happens here. Basically, the program loads the addresses of 4 library functions, system, strchr, strrchr and strcmp into rax, then loads the addresses of 4 other functions into rdx and finally replaces the library function addresses with the 4 other functions. (These addresses are saved in the GOT, the Global Offset Table). This means that every team one of those library functions gets called, the binary actually calls one of the other 4 functions. This also explains why the call to strchr produced such a weird result. The way forward should seem clear now, we need to reverse each one of the four functions and see what they are doing. So let’s start doing that:</p> <h2 id="strchr">strchr</h2> <p>In the following cases, I’ll use ghidra to simplify the task a bit. When I was originally solving the challenges, I was using a combination of the decompilation provided by ghidra together with dynamic analysis with radare2 to check my findings. For the strchr function, ghidra gives us:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">while</span> <span class="p">(</span><span class="n">local_c</span> <span class="o">&lt;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">local_10</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">&lt;</span> <span class="n">param_2</span> <span class="o">-</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">uVar1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar1</span><span class="p">))</span> <span class="p">{</span>
      <span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_c</span> <span class="o">+</span> <span class="n">param_1</span><span class="p">)</span> <span class="o">=</span>
           <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">local_c</span><span class="p">)</span> <span class="o">*</span> <span class="sc">'\x02'</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">local_c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
      <span class="n">local_10</span> <span class="o">=</span> <span class="n">local_10</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">local_c</span> <span class="o">=</span> <span class="n">local_c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
</code></pre></div></div> <p>This is a lot of code and it’s also not that easily readable so I’ll talk you through it. Basically, the code loops over each character provided to it as param_1 (our input). For each character it does param_2 iterations (param_2 is always 3 in our case) of the following procedure: It multiplies the char by two, then ORs it by the character’s value shifted to the right by 7. This means that if the character is bigger than 0x7F (binary: 0111 1111 » 7 = 0000 0000), we add 1, if not we add nothing. This process is easily reversible, following the python decryption code that takes as input a hex string (excuse my laziness, I actually just generated a lookuplist for each input character):</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dictionary</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="mi">128</span><span class="p">):</span>
	<span class="n">char</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
	<span class="n">encrypted</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">char</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#encrypt is an implementation of the encrypt routine described above
</span>	<span class="n">dictionary</span><span class="p">[</span><span class="n">encrypted</span><span class="p">]</span> <span class="o">=</span> <span class="n">char</span>

<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">strings</span><span class="p">):</span>
	<span class="n">result</span> <span class="o">=</span> <span class="s">""</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">strings</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">):</span>
		<span class="n">char</span> <span class="o">=</span> <span class="n">strings</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">result</span> <span class="o">+=</span> <span class="n">dictionary</span><span class="p">[</span><span class="n">char</span><span class="p">]</span>
		<span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
			<span class="n">result</span> <span class="o">+=</span> <span class="s">"?"</span>
	<span class="k">return</span> <span class="n">result</span>
</code></pre></div></div> <p>Now we can reverse the first encryption function, so on to the next</p> <h2 id="system">system</h2> <p>Again, decompiled ghidra output:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">while</span> <span class="p">(</span><span class="n">local_c</span> <span class="o">&lt;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">local_c</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">local_c</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">local_c</span> <span class="o">+</span> <span class="mi">5U</span><span class="p">;</span>
    <span class="n">local_c</span> <span class="o">=</span> <span class="n">local_c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div> <p>This time, the code is really short and easy to understand. It loops over the input array and xors each value with 5 + the iteration. This means that the first char is xored with 5, the second with 6 and so on. Here is the decryption routine implemented in python:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">decrypt2</span><span class="p">(</span><span class="n">strings</span><span class="p">):</span>
	<span class="n">result</span> <span class="o">=</span> <span class="s">""</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">strings</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">):</span>
		<span class="n">char</span> <span class="o">=</span> <span class="n">strings</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
		<span class="n">number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">char</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
		<span class="n">number</span> <span class="o">=</span> <span class="n">number</span> <span class="o">^</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">number</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
			<span class="n">result</span> <span class="o">+=</span> <span class="s">"0"</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">number</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">result</span> <span class="o">+=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">number</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
	<span class="k">return</span> <span class="n">result</span>
</code></pre></div></div> <p>The function again expects a hex string as parameter and the small construct at the end makes sure that each hex output is also two chars long (This caused me a few headaches when I couldn’t get the correct output). Alright, on to the next encryption.</p> <h2 id="strrchr">strrchr</h2> <p>ghidra:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">while</span> <span class="p">(</span><span class="n">local_c</span> <span class="o">&lt;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">local_10</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">&lt;</span> <span class="n">param_2</span> <span class="o">-</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">uVar2</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar2</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">bVar1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">local_c</span><span class="p">);</span>
      <span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">local_c</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">local_c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
      <span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">local_c</span><span class="p">)</span> <span class="o">=</span>
           <span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">local_c</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">byte</span><span class="p">)((</span><span class="kt">int</span><span class="p">)(</span><span class="kt">char</span><span class="p">)(</span><span class="n">bVar1</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
      <span class="n">local_10</span> <span class="o">=</span> <span class="n">local_10</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">local_c</span> <span class="o">=</span> <span class="n">local_c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
</code></pre></div></div> <p>This part also isn’t too hard. The code basically does some bit-shifting. For each iteration, which is defined by param_2 which in our case is always 2, it takes an input byte, shifts it one to the left and then puts the lowest bit of that input byte in the highest bit place. As an example, we can take 0xA7 which is 1010 0111 in binary. The resulting binary number after the bit shifting would be <strong>11</strong>10 1001 which is 0xE9 in hexadecimal. A decryption function in python could look like this:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">decrypt3</span><span class="p">(</span><span class="n">strings</span><span class="p">,</span><span class="n">loops</span><span class="p">):</span>
	<span class="n">result</span> <span class="o">=</span> <span class="s">""</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">strings</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">):</span>
		<span class="n">char</span> <span class="o">=</span> <span class="n">strings</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
		<span class="n">number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">char</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">loops</span><span class="p">):</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">number</span> <span class="o">&amp;</span> <span class="mh">0x7F</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
			<span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">number</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">7</span>
			<span class="n">number</span> <span class="o">=</span> <span class="n">right</span> <span class="o">+</span> <span class="n">left</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">number</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
			<span class="n">result</span> <span class="o">+=</span> <span class="s">"0"</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">number</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">result</span> <span class="o">+=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">number</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
	<span class="k">return</span> <span class="n">result</span>
</code></pre></div></div> <p>This just shifts the bits in the opposite direction and again expects a hex string as input.</p> <h2 id="strcmp">strcmp</h2> <p>We’re now close to the finish line, the only function that still needs to be analyzed is strcmp. ghidra gives us:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">while</span> <span class="p">(</span><span class="n">local_c</span> <span class="o">&lt;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">param_1</span><span class="p">[</span><span class="n">local_c</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_1</span><span class="p">[</span><span class="n">local_c</span><span class="p">]</span> <span class="o">^</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">local_c</span> <span class="o">=</span> <span class="n">local_c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">iVar1</span> <span class="o">=</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">param_1</span><span class="p">,</span><span class="n">param_2</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="err">}</span>
</code></pre></div></div> <p>Again quite a short function, that does a little bit of encryption as well as the final check. First, the encryption that is done here is a simple xor with 10 on each character, easily reversible with the following code:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">decrypt4</span><span class="p">(</span><span class="n">strings</span><span class="p">):</span>
	<span class="n">result</span> <span class="o">=</span> <span class="s">""</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">strings</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">):</span>
		<span class="n">char</span> <span class="o">=</span> <span class="n">strings</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
		<span class="n">number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">char</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
		<span class="n">number</span> <span class="o">=</span> <span class="n">number</span> <span class="o">^</span> <span class="mi">10</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">number</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
			<span class="n">result</span> <span class="o">+=</span> <span class="s">"0"</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">number</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">result</span> <span class="o">+=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">number</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
	<span class="k">return</span> <span class="n">result</span>
</code></pre></div></div> <p>After that, the binary calls strncmp which compares two strings for a given length, in out case a length of 0x1f. The function then checks if the output is equal to zero, so if the two strings are equal and returns to main. What we need to do now is to extract the string it’s compared against, we can find in the main function that it’s located at 0x404080. In radare, the memory at that address looks like this:</p> <p><img src="/assets/img/posts/easy-obfuscation/thou_shall4.png" alt="memory" /></p> <p>Having that we can finally solve the challenge by chaining the decryption calls. In my example, the code looked like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>encoded = "fbd1518aee7e54699b6f77b080ee70c1296771e49cea72ed935f11eaa478"
print(decrypt(decrypt2(decrypt3(decrypt4(encoded),2))))
</code></pre></div></div> <p>Running this gives us the flag X-MAS{N0is__g0_g3t_th3_points}</p> <h2 id="summary">Summary</h2> <p>Great challenge to start off the CTF even though it was already quite tough for only 50 points. In general, the challenges in this CTF were way harder than at any others I had previously participated in but it was nice to just be tenacious and not give up even if it took more than 5 hours to finally get the solution (one of the other challenges in this CTF). The next writeups won’t go into this much detail, I just always think it’s nice to explain the first challenge extremely clear so people that couldn’t solve it can learn new stuff and tackle it at the next CTF.Hope you liked this writeup -Trigleos</p> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="/blog/easy-obfuscation/" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About Pol Thill </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="/assets/img/authors/trigleos.png" alt="Pol Thill" /> </div> <div class="col-md-6"> <p class="author_bio">Hi I am Pol, a Cybersecurity student.</p> <p>Email : pthill99@gmail.com</p> <p>Website : https://trigleos.github.io</p> <p class="profile-links"> <a class="social-link" href="https://github.com/trigleos" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/pol-thill-985b02190" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> <a class="social-link" href="https://www.twitter.com/tr3gleos" target="_blank"><i class="fab fa-twitter fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> </div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About Mallux</div> <div class="card-body"> <p class="author_bio">Mallux is a blog where I write about Cybersecurity.</p> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#Csharp"></div> <li class="tag-head"> <a href="/blog/categories/Csharp">Csharp</a> </li> <a name="Csharp"></a> <div id="#Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Reversing">Reversing</a> </li> <a name="Reversing"></a> <div id="#Windows_Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Windows_Reversing">Windows_Reversing</a> </li> <a name="Windows_Reversing"></a> <div id="#Assembly"></div> <li class="tag-head"> <a href="/blog/categories/Assembly">Assembly</a> </li> <a name="Assembly"></a> <div id="#Linux_Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Linux_Reversing">Linux_Reversing</a> </li> <a name="Linux_Reversing"></a> <div id="#Ransomware"></div> <li class="tag-head"> <a href="/blog/categories/Ransomware">Ransomware</a> </li> <a name="Ransomware"></a> <div id="#Networking"></div> <li class="tag-head"> <a href="/blog/categories/Networking">Networking</a> </li> <a name="Networking"></a> <div id="#Forensics"></div> <li class="tag-head"> <a href="/blog/categories/Forensics">Forensics</a> </li> <a name="Forensics"></a> <div id="#RSA"></div> <li class="tag-head"> <a href="/blog/categories/RSA">RSA</a> </li> <a name="RSA"></a> <div id="#AES"></div> <li class="tag-head"> <a href="/blog/categories/AES">AES</a> </li> <a name="AES"></a> <div id="#Threat_Hunting"></div> <li class="tag-head"> <a href="/blog/categories/Threat_Hunting">Threat_Hunting</a> </li> <a name="Threat_Hunting"></a> <div id="#Incident_Response"></div> <li class="tag-head"> <a href="/blog/categories/Incident_Response">Incident_Response</a> </li> <a name="Incident_Response"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="/">Home</a> </li> <li> <a href="/blog">Blog</a> </li> </div> </div> </div> </div> </div><footer> <p> Powered by<a href="https://github.com/sujaykundu777/devlopr-jekyll"> devlopr jekyll</a>.Hosted on <a href="https://www.netlify.com/">Netlify</a>. </p> </footer> <script> var options = { classname: 'my-class', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <script src="/assets/js/mode-switcher.js"></script> </body> </html>
