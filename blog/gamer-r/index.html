<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> Gamer R -Mallux </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="Reverse a Unity game and patch it- Gamer R"> <meta name="keywords" content="Gamer R, Mallux, Csharp, Reversing, Windows_Reversing,.NET Reversing, Unity game patching, Reversing, C# Reversing"/> <meta content="" property="fb:app_id" /> <meta content="Mallux" property="og:site_name" /> <meta content="Gamer R" property="og:title" /> <meta content="article" property="og:type" /> <meta content="Reverse a Unity game and patch it" property="og:description" /> <meta content="/blog/gamer-r/" property="og:url" /> <meta content="2020-05-24T18:00:00+00:00" property="article:published_time" /> <meta content="/about/" property="article:author" /> <meta content="/assets/img/posts/gamer_r/unity.jpg" property="og:image" /> <meta content="Csharp" property="article:section" /> <meta content="Windows" property="article:tag" /> <meta content="Reversing," property="article:tag" /> <meta content="Reversing," property="article:tag" /> <meta content="C#" property="article:tag" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="Gamer R" /> <meta name="twitter:url" content="/blog/gamer-r/" /> <meta name="twitter:description" content="Reverse a Unity game and patch it" /> <link rel="stylesheet" href="/assets/css/main.css" /> <!-- <link rel="stylesheet" href="/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = '' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="/assets/js/search.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <!-- for Mathjax support --> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">Mallux</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="/blog" >Blog</a > </li> </ul> </div> <ul class="nav justify-content-end"> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <li class="nav-item"> <input class="nav-link switch" id="theme-toggle" onclick="modeSwitcher() " type="checkbox" name="checkbox" /> </li> </ul> </nav> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div> <div class="col-lg-12"> <div class="row" id="blog-post-container"> <div class="col-lg-8 offset-md-2"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">Gamer R</h1> <h4 class="post-meta">Reverse a Unity game and patch it</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="/blog/authors/trigleos">trigleos</a></span> </span > at <time datetime="2020-05-24 18:00:00 +0000" itemprop="datePublished" >May 24, 2020</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/gamer-r/" ></span> <div class="post-categories"> Category : <a href="/blog/categories/Csharp" >Csharp</a > &nbsp; <a href="/blog/categories/Reversing" >Reversing</a > &nbsp; <a href="/blog/categories/Windows_Reversing" >Windows_Reversing</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="/assets/img/posts/gamer_r/unity.jpg" alt="" /> <br /> <br /> <h1 id="gamer-r">Gamer R</h1> <h2 id="tldr">TL;DR</h2> <p>Reverse a Unity game and patch it to get the flag</p> <h2 id="description">Description</h2> <p>This challenge was the last Reversing challenge for TJCTF and gave 80 points. The challenge provided you with a folder that contained a binary as well as several Unity related files and libraries. The game itself was pretty simple. All you had to do was hit space to shoot a knife and hit an orange, all while trying to avoid hitting the ducks swimming randomly in between. If you manage to hit the orange, your score gets increased by 1.</p> <p><img src="/assets/img/posts/gamer_r/game.gif" alt="game" /></p> <p>When hitting a duck, your score gets reset to zero,</p> <p><img src="/assets/img/posts/gamer_r/gameover.gif" alt="gameover" /></p> <p>which means that we probably need to reach a certain score to get the flag. Unity games are normally written in C# which is an interpreted language that generates a bytecode instead of machine code which means that we can easily decompile it. I’ll use dnSpy to decompile the program.</p> <h2 id="reversing">Reversing</h2> <p>Unity stores the game logic in <em>Projectname</em>_Data/Managed/Assembly-CSharp.dll so let’s open it in dnSpy</p> <p><img src="/assets/img/posts/gamer_r/dnSpy.png" alt="dnSpy" /></p> <p>Let’s try to make the game easier by changing the duck collision behaviour described in the class DuckCollisionSystem. The important part of the code looks like this:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span>  <span class="p">(</span><span class="n">Vector2</span><span class="p">.</span><span class="nf">Distance</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">ducks</span><span class="p">.</span><span class="n">Transforms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">,</span>  <span class="k">this</span><span class="p">.</span><span class="n">knife</span><span class="p">.</span><span class="n">Transforms</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">position</span><span class="p">)</span>  <span class="p">&lt;</span>  <span class="k">this</span><span class="p">.</span><span class="n">hitBoxRadius</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">...</span>
	<span class="nf">collision</span><span class="p">()</span>
	<span class="p">...</span>
<span class="p">}</span>
<span class="k">private</span>  <span class="kt">float</span>  <span class="n">hitBoxRadius</span>  <span class="p">=</span>  <span class="m">0.6f</span><span class="p">;</span>
</code></pre></div></div> <p>The code basically checks if the distance between a duck and the knife is smaller than the specified hitbox radius. If yes, a collision is detected. We can easily bypass this check by changing the value of the hitBoxRadius variable</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">private</span>  <span class="kt">float</span>  <span class="n">hitBoxRadius</span>  <span class="p">=</span>  <span class="p">-</span><span class="m">1.0f</span><span class="p">;</span>
</code></pre></div></div> <p>After recompiling the code, we can now shoot as many knives as we want without hitting any duck. While i was playing the patched version, I noticed that the score showed a letter instead of a number every multiple of 20, so I played a while to see if the flag would be showing up.</p> <p><img src="/assets/img/posts/gamer_r/hacked.gif" alt="patched" /></p> <p>The issue however was that the encoded text was really long and it took me ages to reach each character. So I decided to take a look at the KnifeMoveSystem class which also dealt with increasing the score</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span>  <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">knife</span><span class="p">.</span><span class="n">Transforms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">.</span><span class="n">y</span>  <span class="p">&gt;</span>  <span class="m">4f</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="p">...</span>
	<span class="k">this</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">Score</span><span class="p">++;</span>  
	<span class="k">this</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">CumScore</span>  <span class="p">+=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">Score</span><span class="p">;</span>
	<span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div> <p>The code checked if a knife had reached the orange and increased the score by one and the CumScore by score. I decided to try and change the value by which score is increased to 20 and recompiled the code</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">Score</span> <span class="p">+=</span> <span class="m">20</span><span class="p">;</span>  
</code></pre></div></div> <p>However this led to an issue and the characters didn’t show up right</p> <p><img src="/assets/img/posts/gamer_r/problem.gif" alt="bug" /></p> <p>So I took a look inside the scoreUpdateSystem class to see what the problem was about</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span>  <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Score</span>  <span class="p">/</span>  <span class="m">20</span>  <span class="p">&lt;</span>  <span class="k">this</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">TextSeq</span><span class="p">.</span><span class="n">Length</span>  <span class="p">&amp;&amp;</span>  <span class="k">this</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Score</span>  <span class="p">%</span>  <span class="m">20</span>  <span class="p">==</span>  <span class="m">0</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="k">this</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">Texts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">text</span>  <span class="p">=</span>  <span class="p">((</span><span class="kt">char</span><span class="p">)(</span><span class="k">this</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">TextSeq</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Score</span>  <span class="p">/</span>  <span class="m">20</span><span class="p">]</span>  <span class="p">^</span>  <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="k">this</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">CumScore</span>  <span class="p">%</span>  <span class="m">4096.0</span><span class="p">))).</span><span class="nf">ToString</span><span class="p">();</span>  
<span class="p">}</span>
</code></pre></div></div> <p>This part checked wether the score was divisible by 20 and if so, it xored a value in the TextSeq array with the CumScore value and put the result into the UI score field. That meant that I had to fix the cumScore value as well when I increased the score by 20 as the cumScore would have normally increased by every integer between 0 and 20. A quick way to do this is to use the formula to calculate a triangular number which basically sums up to : cumScore = ((score)*(score+1))/2 Implemented in C# this gives us:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">CumScore</span>  <span class="p">=</span>  <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">Score</span>  <span class="p">*</span>  <span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">Score</span>  <span class="p">+</span>  <span class="m">1.0</span><span class="p">)</span>  <span class="p">/</span>  <span class="m">2.0</span><span class="p">;</span>
</code></pre></div></div> <p>Recompiling the game gives us a working patch that gets us the flag way faster</p> <p><img src="/assets/img/posts/gamer_r/solution.gif" alt="solution" /></p> <p>The letters found in the score field build up following text: HERE’S THE FLAG YOU’RE LOOKING FOR! HAHA JKJK… UNLESS…? TJCTF{ORENJI_MANGGOE} and we have our flag</p> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="/blog/gamer-r/" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About Pol Thill </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="/assets/img/authors/trigleos.png" alt="Pol Thill" /> </div> <div class="col-md-6"> <p class="author_bio">Hi I am Pol, a Cybersecurity student.</p> <p>Email : pthill99@gmail.com</p> <p>Website : https://trigleos.github.io</p> <p class="profile-links"> <a class="social-link" href="https://github.com/trigleos" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/pol-thill-985b02190" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> <a class="social-link" href="https://www.twitter.com/tr3gleos" target="_blank"><i class="fab fa-twitter fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> </div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About Mallux</div> <div class="card-body"> <p class="author_bio">Mallux is a blog where I write about Cybersecurity.</p> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#Csharp"></div> <li class="tag-head"> <a href="/blog/categories/Csharp">Csharp</a> </li> <a name="Csharp"></a> <div id="#Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Reversing">Reversing</a> </li> <a name="Reversing"></a> <div id="#Windows_Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Windows_Reversing">Windows_Reversing</a> </li> <a name="Windows_Reversing"></a> <div id="#Assembly"></div> <li class="tag-head"> <a href="/blog/categories/Assembly">Assembly</a> </li> <a name="Assembly"></a> <div id="#Linux_Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Linux_Reversing">Linux_Reversing</a> </li> <a name="Linux_Reversing"></a> <div id="#Ransomware"></div> <li class="tag-head"> <a href="/blog/categories/Ransomware">Ransomware</a> </li> <a name="Ransomware"></a> <div id="#Networking"></div> <li class="tag-head"> <a href="/blog/categories/Networking">Networking</a> </li> <a name="Networking"></a> <div id="#Forensics"></div> <li class="tag-head"> <a href="/blog/categories/Forensics">Forensics</a> </li> <a name="Forensics"></a> <div id="#RSA"></div> <li class="tag-head"> <a href="/blog/categories/RSA">RSA</a> </li> <a name="RSA"></a> <div id="#AES"></div> <li class="tag-head"> <a href="/blog/categories/AES">AES</a> </li> <a name="AES"></a> <div id="#Threat_Hunting"></div> <li class="tag-head"> <a href="/blog/categories/Threat_Hunting">Threat_Hunting</a> </li> <a name="Threat_Hunting"></a> <div id="#Incident_Response"></div> <li class="tag-head"> <a href="/blog/categories/Incident_Response">Incident_Response</a> </li> <a name="Incident_Response"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="/">Home</a> </li> <li> <a href="/blog">Blog</a> </li> </div> </div> </div> </div> </div><footer> <p> Powered by<a href="https://github.com/sujaykundu777/devlopr-jekyll"> devlopr jekyll</a>.Hosted on <a href="https://www.netlify.com/">Netlify</a>. </p> </footer> <script> var options = { classname: 'my-class', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <script src="/assets/js/mode-switcher.js"></script> </body> </html>
