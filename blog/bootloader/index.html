<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> Bootloader -Mallux </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="Debug and fix a bootloader that decrypts a flag- Bootloader"> <meta name="keywords" content="Bootloader, Mallux, Reversing, Linux_Reversing,Reversing, CTF, Linux Reversing, Bootloader, 16-bit"/> <meta content="" property="fb:app_id" /> <meta content="Mallux" property="og:site_name" /> <meta content="Bootloader" property="og:title" /> <meta content="article" property="og:type" /> <meta content="Debug and fix a bootloader that decrypts a flag" property="og:description" /> <meta content="/blog/bootloader/" property="og:url" /> <meta content="2021-01-31T18:00:00+00:00" property="article:published_time" /> <meta content="/about/" property="article:author" /> <meta content="/assets/img/posts/bootloader/spacejackal.jpg" property="og:image" /> <meta content="Reversing" property="article:section" /> <meta content="Linux" property="article:tag" /> <meta content="Reversing," property="article:tag" /> <meta content="Reversing," property="article:tag" /> <meta content="Bootloader," property="article:tag" /> <meta content="16-bit" property="article:tag" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="Bootloader" /> <meta name="twitter:url" content="/blog/bootloader/" /> <meta name="twitter:description" content="Debug and fix a bootloader that decrypts a flag" /> <link rel="stylesheet" href="/assets/css/main.css" /> <!-- <link rel="stylesheet" href="/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = '' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="/assets/js/search.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <!-- for Mathjax support --> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">Mallux</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="/blog" >Blog</a > </li> </ul> </div> <ul class="nav justify-content-end"> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <li class="nav-item"> <input class="nav-link switch" id="theme-toggle" onclick="modeSwitcher() " type="checkbox" name="checkbox" /> </li> </ul> </nav> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div> <div class="col-lg-12"> <div class="row" id="blog-post-container"> <div class="col-lg-8 offset-md-2"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">Bootloader</h1> <h4 class="post-meta">Debug and fix a bootloader that decrypts a flag</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="/blog/authors/trigleos">trigleos</a></span> </span > at <time datetime="2021-01-31 18:00:00 +0000" itemprop="datePublished" >Jan 31, 2021</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/bootloader/" ></span> <div class="post-categories"> Category : <a href="/blog/categories/Reversing" >Reversing</a > &nbsp; <a href="/blog/categories/Linux_Reversing" >Linux_Reversing</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="/assets/img/posts/bootloader/spacejackal.jpg" alt="" /> <br /> <br /> <h1 id="the-proclamation">The Proclamation</h1> <h2 id="tldr">TL;DR</h2> <p>Debug and fix a bootloader that decrypts a flag</p> <h2 id="description">Description</h2> <p>A mysterious file appeared on a deep dark web forum. Can you figure out what we can’t see right now?</p> <p><strong>NOTE:</strong> Flags will be easily identifiable by following the format CS{some_secret_flag_text}. They must be submitted in full, including the CS{ and } parts.</p> <p>The challenge provides us with a proclamation.dat file</p> <h2 id="initial-analysis">Initial analysis</h2> <p>To determine what the file proclamation.dat is, let’s run file on it. This gives us <strong>DOS/MBR boot sector</strong>. The MBR or Master Boot Record is a special sector of a partitioned drive. It is at the beginning of a drive (for example a USB drive) and contains an executable program called the bootloader, information on each partition on the drive and a magic number at the end. In our case, the bootloader is the most interesting part. Normally it is used at startup to call a secondary program that sets up the OS but sometimes, adversaries will corrupt this program to gain persistence. Code that’s saved in the MBR will basically be executed before the OS even starts so it operates outside of OS boundaries and can evade AV programs. Let’s see what happens if we run the drive using a virtualisation software. I used qemu for this challenge. The command that starts the VM is <strong>qemu-system-i386 proclamation.dat</strong></p> <p><img src="/assets/img/posts/bootloader/boot1.png" alt="vm" /></p> <p>So the bootloader only displays this text. There’s no interaction with the program so there must be something hidden in the bootloader. If we run strings on the proclamation.dat file, the only thing we get is you’re on a good way. We can’t find any of the other strings that are displayed so they must be encrypted in some way.</p> <h2 id="static-analysis">Static Analysis</h2> <p>Now let’s take a look at the code. radare2 is a great tool to do this, simply run r2 -b proclamation.dat to see the dissassembly. The important part of the program starts at 0x1b.</p> <p><img src="/assets/img/posts/bootloader/boot2.png" alt="code" /></p> <p>I’ll write the important parts to notice now in different sections</p> <h3 id="first-operand">first operand</h3><pre><code class="language-assembly">mov dl, 9
push edx
</code></pre><p>Start of loop:</p><pre><code class="language-assembly">pop edx
shl edx, 2
add edx, 0x42
and edx, 0xff
push edx
</code></pre><p>This part of the code initializes a variable with 9, then on each iteration of a loop does some bit shifting and addition on it</p> <h3 id="second-operand">second operand</h3><pre><code class="language-assembly">mov al, byte[si]
add si, 1
</code></pre><p>This loops over some data array at si and puts the bytes into al</p> <h3 id="xor">xor</h3><pre><code class="language-assembly">xor eax, edx
or al, 0
je 0x5f
mov dl, al
xor dl, 0xa
je 0x51
int 0x10
jmp 0x23
</code></pre><p>The two operands are xored, then the result is first compared against 0xa (new line) then against 0x0. If it’s not one of either, the program traps to the BIOS that then teletypes (AH=0xe) the value inside al (the xored value). If it is 0x0, the program halts. Now that we know what the program does, we need to get the starting value of si to get the start point of the data array.</p> <h2 id="dynamic-analysis">Dynamic Analysis</h2> <p>To debug a bootloader, we can use the remote gdb debugging feature of qemu. We start a session with qemu-system-i386 -s -S -m 512 -hda proclamation.dat Then we start gdb and type in the following commands:</p> <p><img src="/assets/img/posts/bootloader/boot3.png" alt="gdb" /></p> <p>We break at 0x7c00 because that’s where the bootloader gets loaded into memory. If we want to get the value for si we should break at instruction 0x27 which, in virtual memory, is 0x7c27.</p> <p>A quick look into the registers tells us that si is 0x7c78 at that point. We know have everything we need. There are two ways to solve this challenge now. If we set a breakpoint inside of the loop and we break repetitively on it, we see how the characters show up on the screen. We can do this until we get a value of 0x0. At this point the program jumps outside of the loop and stops. However, we can overwrite the instruction pointer and make it point to the start of the loop instead to let it continue decrypting the remaining bytes. If we do this, the following shows up:</p> <p><img src="/assets/img/posts/bootloader/boot4.png" alt="flag" /></p> <p>So the flag is CS{0rd3r_0f_0x20_b00tl0ad3r}. Another way to get this flag is by writing a simple python script that takes care of the decryption:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">encoded_data</span> <span class="o">=</span> <span class="s">"2ebfc68685c4cabd8fca8b988fca8685858183848dca8c8598ca82838d828693ca83849e8f8686838d8f849ee083848e839c838e9f8b8699c4cabe85ca8c83848eca9e828f87c6ca9d8fca828b9c8fca8e8f9c83998f8ee08bca9e8f999ec4e0e0be828f988fca8399ca8bca878f99998b8d8fca82838e8e8f84ca8384ca9e828399ca8885859e86858b8e8f98c4e0e0ac83848eca839ec6ca8b848eca839eca9d838686ca868f8b8eca93859fca8584ca9e828fca98858b8eca9e85e08c83848e83848dca9f99c4cabd8fca86858581ca8c85989d8b988eca9e85ca878f8f9eca9e828fe08c8f9dca9e828b9eca9d838686ca878b818fca839eca8b8686ca9e828fca9d8b93ca9e8298859f8d82c4e0e0ad85858eca869f8981c6ca8b848eca988f878f87888f98d0e0cacacacabd8fca86859c8fca999a8b898f99ca879f8982ca8785988fca9e828b84ca9e8b8899cbea811911a9b991da988ed998b5da8cb5da92d8dab588dada9e86da8b8ed9989797eaf4f4f4f4f4f4f4f4f4f4f4f4f4f4f4f4f4f4f455aa"</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">encoded_data</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">encoded_data</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span><span class="mi">16</span><span class="p">))</span>
<span class="n">variable</span> <span class="o">=</span> <span class="mi">9</span>
<span class="k">for</span> <span class="n">dat</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="n">variable</span> <span class="o">=</span> <span class="n">variable</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
    <span class="n">variable</span> <span class="o">+=</span> <span class="mh">0x42</span>
    <span class="n">variable</span> <span class="o">=</span> <span class="n">variable</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">dat</span><span class="o">^</span><span class="n">variable</span><span class="p">),</span><span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
</code></pre></div></div> <p>The encoded data was extracted from proclamation.dat at the start offset 0x78, the value which, as we established earlier, was inside si at the first iteration of the loop. If we run this, we get the entire text that shows up.</p> <h2 id="conclusion">Conclusion</h2> <p>This challenge was extremely interesting. It was the first time that I debugged a bootloader so I had to read up a lot on qemu and on how to use gdb as a remote debugger. In the process, I learned a lot about bootloader malware and I noticed the brilliance of radare2. Where ghidra failed, radare still produced a perfect dissassembly. The Crowdstrike CTF had a bunch of other really interesting challenges. Most of them were however quite hard and I didn’t really have a lot of time to put into them. I will look into some once I have more time and maybe I’ll publish some more writeups. Until next time -Trigleos</p> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="/blog/bootloader/" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About Pol Thill </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="/assets/img/authors/trigleos.png" alt="Pol Thill" /> </div> <div class="col-md-6"> <p class="author_bio">Hi I am Pol, a Cybersecurity student.</p> <p>Email : pthill99@gmail.com</p> <p>Website : https://trigleos.github.io</p> <p class="profile-links"> <a class="social-link" href="https://github.com/trigleos" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/pol-thill-985b02190" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> <a class="social-link" href="https://www.twitter.com/tr3gleos" target="_blank"><i class="fab fa-twitter fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> </div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About Mallux</div> <div class="card-body"> <p class="author_bio">Mallux is a blog where I write about Cybersecurity.</p> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#Csharp"></div> <li class="tag-head"> <a href="/blog/categories/Csharp">Csharp</a> </li> <a name="Csharp"></a> <div id="#Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Reversing">Reversing</a> </li> <a name="Reversing"></a> <div id="#Windows_Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Windows_Reversing">Windows_Reversing</a> </li> <a name="Windows_Reversing"></a> <div id="#Assembly"></div> <li class="tag-head"> <a href="/blog/categories/Assembly">Assembly</a> </li> <a name="Assembly"></a> <div id="#Linux_Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Linux_Reversing">Linux_Reversing</a> </li> <a name="Linux_Reversing"></a> <div id="#Ransomware"></div> <li class="tag-head"> <a href="/blog/categories/Ransomware">Ransomware</a> </li> <a name="Ransomware"></a> <div id="#Networking"></div> <li class="tag-head"> <a href="/blog/categories/Networking">Networking</a> </li> <a name="Networking"></a> <div id="#Forensics"></div> <li class="tag-head"> <a href="/blog/categories/Forensics">Forensics</a> </li> <a name="Forensics"></a> <div id="#RSA"></div> <li class="tag-head"> <a href="/blog/categories/RSA">RSA</a> </li> <a name="RSA"></a> <div id="#AES"></div> <li class="tag-head"> <a href="/blog/categories/AES">AES</a> </li> <a name="AES"></a> <div id="#Threat_Hunting"></div> <li class="tag-head"> <a href="/blog/categories/Threat_Hunting">Threat_Hunting</a> </li> <a name="Threat_Hunting"></a> <div id="#Incident_Response"></div> <li class="tag-head"> <a href="/blog/categories/Incident_Response">Incident_Response</a> </li> <a name="Incident_Response"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="/">Home</a> </li> <li> <a href="/blog">Blog</a> </li> </div> </div> </div> </div> </div><footer> <p> Powered by<a href="https://github.com/sujaykundu777/devlopr-jekyll"> devlopr jekyll</a>.Hosted on <a href="https://www.netlify.com/">Netlify</a>. </p> </footer> <script> var options = { classname: 'my-class', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <script src="/assets/js/mode-switcher.js"></script> </body> </html>
