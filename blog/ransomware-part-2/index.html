<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> Ransomware Part II -Mallux </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="Investigate a Ransomware executable and reverse the encryption- Ransomware Part II"> <meta name="keywords" content="Ransomware Part II, Mallux, Assembly, Reversing, Linux_Reversing, Ransomware,Ransomware, CTF, XOR encryption, Reverse Engineering, radare2"/> <meta content="" property="fb:app_id" /> <meta content="Mallux" property="og:site_name" /> <meta content="Ransomware Part II" property="og:title" /> <meta content="article" property="og:type" /> <meta content="Investigate a Ransomware executable and reverse the encryption" property="og:description" /> <meta content="/blog/ransomware-part-2/" property="og:url" /> <meta content="2020-10-20T18:00:00+00:00" property="article:published_time" /> <meta content="/about/" property="article:author" /> <meta content="/assets/img/posts/ransomware-part-1/WannaCry.jpg" property="og:image" /> <meta content="Assembly" property="article:section" /> <meta content="Windows" property="article:tag" /> <meta content="Reversing," property="article:tag" /> <meta content="Reversing," property="article:tag" /> <meta content="C#," property="article:tag" /> <meta content="Ransomware" property="article:tag" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="Ransomware Part II" /> <meta name="twitter:url" content="/blog/ransomware-part-2/" /> <meta name="twitter:description" content="Investigate a Ransomware executable and reverse the encryption" /> <link rel="stylesheet" href="/assets/css/main.css" /> <!-- <link rel="stylesheet" href="/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = '' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="/assets/js/search.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <!-- for Mathjax support --> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">Mallux</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="/blog" >Blog</a > </li> </ul> </div> <ul class="nav justify-content-end"> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <li class="nav-item"> <input class="nav-link switch" id="theme-toggle" onclick="modeSwitcher() " type="checkbox" name="checkbox" /> </li> </ul> </nav> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div> <div class="col-lg-12"> <div class="row" id="blog-post-container"> <div class="col-lg-8 offset-md-2"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">Ransomware Part II</h1> <h4 class="post-meta">Investigate a Ransomware executable and reverse the encryption</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="/blog/authors/trigleos">trigleos</a></span> </span > at <time datetime="2020-10-20 18:00:00 +0000" itemprop="datePublished" >Oct 20, 2020</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/ransomware-part-2/" ></span> <div class="post-categories"> Category : <a href="/blog/categories/Assembly" >Assembly</a > &nbsp; <a href="/blog/categories/Reversing" >Reversing</a > &nbsp; <a href="/blog/categories/Linux_Reversing" >Linux_Reversing</a > &nbsp; <a href="/blog/categories/Ransomware" >Ransomware</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="/assets/img/posts/ransomware-part-1/WannaCry.jpg" alt="" /> <br /> <br /> <h1 id="castorsctf2020">castorsCTF2020</h1> <h2 id="tldr">TL;DR</h2> <p>Investigating a Ransomware attack and try to reverse the process</p> <h2 id="description">Description</h2> <p>This is the second part of a two part series. In this part, we’ll apply the knowledge we got from analysing the executable in part 1 and reverse the encrypted image</p> <h2 id="recap">Recap</h2> <p>In part 1, we discovered that the executable contacts a server to get a seed and that that seed is then used to encrypt the flag using simple xor encryption. So let’s start by investigating the pcap that is part of the challenge</p> <h2 id="network-analysis">Network analysis</h2> <p>We already discovered that the executable is contacting a server sitting at the IP address 192.168.0.2. The pcap file confirms this as well as the exact http call.</p> <p><img src="/assets/img/posts/ransomware-part-2/packet1.png" alt="http" /></p> <p>From the investigation of the executable, we know that the seed is only accepted if the server sends back an “ok” at the end of the exchange. Let’s see if we can find one.</p> <p><img src="/assets/img/posts/ransomware-part-2/packet2.png" alt="seed" /></p> <p>The capture contains 5 GET requests. However, only the last one is followed by POST sent from the client executable (the actual ransomware). If we take a look at that POST request, we can find the chosen seed</p> <p><img src="/assets/img/posts/ransomware-part-2/packet3.png" alt="seed_success" /></p> <p>Now that we know that the seed is 1337, we can finally start to write the programs that help us decrypt the image</p> <h2 id="generating-the-random-sequence-and-decrypting-the-image">Generating the random sequence and decrypting the image</h2> <p>In order to get the random sequence that was used to encrypt the image, we need to write a Go program that generates it. You could easily write the entire solution in Go and let it also decrypt the file but before this challenge I had never used Go so I just limited myself to writing a function to generate and output the numbers. The last thing we need to find out is how long the image is so we know how many numbers we need to generate. A simple ls -l shows us that the image is 1441 bytes big (fairly small).With this info we can now write the Go program</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"fmt"</span>
	<span class="s">"math/rand"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">rand</span><span class="o">.</span><span class="n">Seed</span><span class="p">(</span><span class="m">1337</span><span class="p">)</span> <span class="c">//the seed</span>
	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="m">1441</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>  <span class="c">//the size of the image</span>
		<span class="n">fmt</span><span class="o">.</span><span class="n">Print</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">Intn</span><span class="p">(</span><span class="m">254</span><span class="p">))</span>  <span class="c">//the range of random numbers</span>
		<span class="n">fmt</span><span class="o">.</span><span class="n">Print</span><span class="p">(</span><span class="s">" "</span><span class="p">)</span>
	<span class="p">}</span>	
<span class="p">}</span>
</code></pre></div></div> <p>Compiling this gives us a working program so let’s save the output to xor_key. I’ll write the main solution script in python because it’s the language I’m the most comfortable with.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xor_key</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"xor_key"</span><span class="p">,</span><span class="s">"r"</span><span class="p">)</span>
<span class="n">xor_list</span> <span class="o">=</span> <span class="n">xor_key</span><span class="p">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#read in key
</span><span class="n">xor_key</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">xor_list</span> <span class="o">=</span> <span class="n">xor_list</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">" "</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"flag.png"</span><span class="p">,</span><span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">encrypted</span><span class="p">:</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"output.png"</span><span class="p">,</span><span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
		<span class="n">byte</span> <span class="o">=</span> <span class="n">encrypted</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">while</span> <span class="n">byte</span> <span class="o">!=</span> <span class="sa">b</span><span class="s">""</span><span class="p">:</span>
			<span class="n">first</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span><span class="s">"big"</span><span class="p">)</span> <span class="c1">#transform byte of image to integer
</span>			<span class="n">second</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xor_list</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="c1">#take integer that was generated
</span>			<span class="n">res</span> <span class="o">=</span> <span class="n">first</span> <span class="o">^</span> <span class="n">second</span> <span class="c1">#xor both
</span>			<span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>
			<span class="n">output</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s">"big"</span><span class="p">))</span> <span class="c1">#write result to output image
</span>			<span class="n">byte</span> <span class="o">=</span> <span class="n">encrypted</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></div> <p>Running this gives us an output.png file so let’s try to open it.</p> <p><img src="/assets/img/posts/ransomware-part-2/final.png" alt="flag" /></p> <p>We managed to recover the encrypted file and defeat the ransomware. I hope you liked this detailed looked into reverse engineering. I’ll try to write some more posts about it because I’m very passionate about these types of challenges and I hope you’ll come back to read them as well.</p> <p>-Trigleos</p> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="/blog/ransomware-part-2/" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About Pol Thill </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="/assets/img/authors/trigleos.png" alt="Pol Thill" /> </div> <div class="col-md-6"> <p class="author_bio">Hi I am Pol, a Cybersecurity student.</p> <p>Email : pthill99@gmail.com</p> <p>Website : https://trigleos.github.io</p> <p class="profile-links"> <a class="social-link" href="https://github.com/trigleos" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/pol-thill-985b02190" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> <a class="social-link" href="https://www.twitter.com/tr3gleos" target="_blank"><i class="fab fa-twitter fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> </div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About Mallux</div> <div class="card-body"> <p class="author_bio">Mallux is a blog where I write about Cybersecurity.</p> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#Csharp"></div> <li class="tag-head"> <a href="/blog/categories/Csharp">Csharp</a> </li> <a name="Csharp"></a> <div id="#Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Reversing">Reversing</a> </li> <a name="Reversing"></a> <div id="#Windows_Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Windows_Reversing">Windows_Reversing</a> </li> <a name="Windows_Reversing"></a> <div id="#Assembly"></div> <li class="tag-head"> <a href="/blog/categories/Assembly">Assembly</a> </li> <a name="Assembly"></a> <div id="#Linux_Reversing"></div> <li class="tag-head"> <a href="/blog/categories/Linux_Reversing">Linux_Reversing</a> </li> <a name="Linux_Reversing"></a> <div id="#Ransomware"></div> <li class="tag-head"> <a href="/blog/categories/Ransomware">Ransomware</a> </li> <a name="Ransomware"></a> <div id="#Networking"></div> <li class="tag-head"> <a href="/blog/categories/Networking">Networking</a> </li> <a name="Networking"></a> <div id="#Forensics"></div> <li class="tag-head"> <a href="/blog/categories/Forensics">Forensics</a> </li> <a name="Forensics"></a> <div id="#RSA"></div> <li class="tag-head"> <a href="/blog/categories/RSA">RSA</a> </li> <a name="RSA"></a> <div id="#AES"></div> <li class="tag-head"> <a href="/blog/categories/AES">AES</a> </li> <a name="AES"></a> <div id="#Threat_Hunting"></div> <li class="tag-head"> <a href="/blog/categories/Threat_Hunting">Threat_Hunting</a> </li> <a name="Threat_Hunting"></a> <div id="#Incident_Response"></div> <li class="tag-head"> <a href="/blog/categories/Incident_Response">Incident_Response</a> </li> <a name="Incident_Response"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="/">Home</a> </li> <li> <a href="/blog">Blog</a> </li> </div> </div> </div> </div> </div><footer> <p> Powered by<a href="https://github.com/sujaykundu777/devlopr-jekyll"> devlopr jekyll</a>.Hosted on <a href="https://www.netlify.com/">Netlify</a>. </p> </footer> <script> var options = { classname: 'my-class', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <script src="/assets/js/mode-switcher.js"></script> </body> </html>
